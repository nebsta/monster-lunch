#!/usr/bin/python3

import subprocess
import os
import shutil
import sys

clean_project = False
run_executable = False

SHADER_GEN_PATH = "src/rendering/_gen_shader"

# check if we need to clean the project or run after building
for arg in sys.argv:
  if arg == "--clean":
    clean_project = True
  elif arg == "--run":
    run_executable = True

# removing the old bin folder
if os.path.isdir("bin"):
  shutil.rmtree("bin")

if clean_project:
  if os.path.isdir("build"):
    shutil.rmtree("build")

  if os.path.exists(".cache"):
    shutil.rmtree(".cache")

if os.path.exists("ml"):
  os.remove("ml")

# installing dependencies using conan
subprocess.run([
  "conan", 
  "install", 
  ".",
  "--output-folder=build", 
  "--build=missing"#,
])

# ensuring the generated shader folder exists
if os.path.isdir(SHADER_GEN_PATH):
  shutil.rmtree(SHADER_GEN_PATH)
os.mkdir(SHADER_GEN_PATH)

# generating the shader files
result = subprocess.run([
  "./tool/sokol-shdc",
  "-i",
  "res/view.glsl",
  "-o",
  f"{SHADER_GEN_PATH}/shader_view.h",
  "-l",
  "glsl330"
])

print(f"RESULT: {result}")

if result.returncode != 0:
  print("Error with shader compilation")
  exit(1)

# Generating the cmake files
os.chdir("build")
subprocess.run([
  "cmake", 
  "..", 
  "-DCMAKE_TOOLCHAIN_FILE='conan_toolchain.cmake'", 
  "-DCMAKE_BUILD_TYPE=Debug",
  "-DCMAKE_EXPORT_COMPILE_COMMANDS=1"
])

# building the project using the generated cmake files
subprocess.run([
  "cmake", 
  "--build", 
  ".", 
  "--config Debug"
])

# move the bin folder to the root dir and run if needed
if os.path.exists("bin"):
  shutil.move("bin", "../bin")

  if run_executable:
    subprocess.run(["../bin/ml"])
