#!/usr/bin/python3

from jinja2 import Environment, FileSystemLoader
import os
import json

root_path = os.path.dirname(os.path.abspath(__file__))
env_path = f"{root_path}/../templates"

atlas_name = "main"

"""
The coorinate space used by Texture packer is
  0,0  1,0

  0,1  1,1

However the UV space within the engine is
 0,1   1,1

 0,0   1,0 

So part of this script is converting between these coordinate spaces
"""


with open(f"{root_path}/../res/images/main.json") as file:
  data = json.load(file)
  atlas_w = data["meta"]["size"]["w"]
  atlas_h = data["meta"]["size"]["h"]
  atlas = {}
  atlas["name"] = atlas_name
  sprites = []
  for sprite_data in data["frames"]:
    frame = sprite_data["frame"]
    sprite_x = frame["x"]
    sprite_y = frame["y"]
    sprite_w = frame["w"]
    sprite_h = frame["h"]

    sprite_left = round(sprite_x / atlas_w, 4)
    sprite_right = round((sprite_x + sprite_w) / atlas_w, 4) 
    sprite_top = round((atlas_h - sprite_y) / atlas_h, 4)
    sprite_bottom = round((atlas_h - (sprite_y + sprite_h)) / atlas_h, 4)
    
    sprite = {
      "name": sprite_data["filename"][:-4],
      "atlas": atlas_name,
      "w": sprite_w,
      "h": sprite_h,
      "tl": { "x": sprite_left, "y": sprite_top },
      "tr": { "x": sprite_right, "y": sprite_top },
      "bl": { "x": sprite_left, "y": sprite_bottom },
      "br": { "x": sprite_right, "y": sprite_bottom },
    }
    sprites.append(sprite)

  atlas["sprites"] = sprites

  environment = Environment(loader=FileSystemLoader(env_path))
  template = environment.get_template("sprite_atlas_template.jinga")

  path = f"{root_path}/../src/sprite/_gen_MainAtlas.hpp"
  with open(path, mode="w", encoding="utf-8") as file:
    file.write(template.render(atlas))

