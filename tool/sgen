#!/usr/bin/python3

from jinja2 import Environment, FileSystemLoader
import os
import json

root_path = os.path.dirname(os.path.abspath(__file__))
env_path = f"{root_path}/../templates"

atlas_name = "main"

with open(f"{root_path}/../res/images/main.json") as file:
  data = json.load(file)
  atlas_w = data["meta"]["size"]["w"]
  atlas_h = data["meta"]["size"]["h"]
  atlas = {}
  atlas["name"] = atlas_name
  sprites = []
  for sprite_data in data["frames"]:
    frame = sprite_data["frame"]
    sprite = {
      "name": sprite_data["filename"][:-4],
      "atlas": atlas_name,
      "tlx": round(frame["x"] / atlas_w, 2),
      "tly": round(frame["y"] / atlas_h, 2),
      "trx" : round((frame["x"] + frame["w"]) / atlas_w, 2),
      "try" : round(frame["y"] / atlas_h, 2),
      "blx" : round(frame["x"] / atlas_w, 2),
      "bly" : round((frame["y"] + frame["h"]) / atlas_h, 2),
      "brx" : round((frame["x"] + frame["w"]) / atlas_w, 2),
      "bry" : round((frame["y"] + frame["h"]) / atlas_h, 2)
    }
    sprites.append(sprite)

  atlas["sprites"] = sprites

  environment = Environment(loader=FileSystemLoader(env_path))
  template = environment.get_template("sprite_atlas_template.jinga")

  path = f"{root_path}/../src/sprite/_gen_MainAtlas.hpp"
  with open(path, mode="w", encoding="utf-8") as file:
    file.write(template.render(atlas))

